<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <title>Candidatos da Vaga - AssisFreela</title>
    <link rel="icon" href="../img/icone_raio.png" type="image/png">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
          :root {
            /* Usando cores do seu exemplo original */
            --primary-yellow: #ffd600;
            --dark-grey: #4a4a4a;
            --light-grey: #e0e0e0;
            --text-grey: #6b6b6b;
          }
          body {
             font-family: 'Plus Jakarta Sans', sans-serif; /* Mantendo a fonte do exemplo */
             min-height: max(884px, 100dvh);
          }
    </style>
</head>
<body>
<div class="relative flex h-auto min-h-screen w-full flex-col bg-white justify-between group/design-root overflow-x-hidden">
    <div>
        <div class="flex items-center bg-white p-4 pb-2 justify-between">
            <button class="text-black flex size-12 shrink-0 items-center" onclick="history.back()"> <svg fill="currentColor" height="24px" viewBox="0 0 256 256" width="24px" xmlns="http://www.w3.org/2000/svg">
                    <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
                </svg>
            </button>
            <h2 class="text-black text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">Candidatos da Vaga</h2>
        </div>

        <h1 id="vaga-title" class="text-black text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 text-left pb-3 pt-5">Carregando detalhes da vaga...</h1>
        <p class="text-[var(--text-grey)] text-base font-normal leading-normal pb-3 pt-1 px-4">
              Veja os profissionais que se candidataram a esta vaga e gerencie suas respostas.
        </p>

        <div class="px-4 py-3">
            <label class="flex flex-col min-w-40 h-12 w-full">
                <div class="flex w-full flex-1 items-stretch rounded-xl h-full border border-[var(--light-grey)]">
                    <div class="text-[var(--text-grey)] flex border-none bg-white items-center justify-center pl-4 rounded-l-xl border-r-0">
                        <svg fill="currentColor" height="24px" viewBox="0 0 256 256" width="24px" xmlns="http://www.w3.org/2000/svg"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg>
                    </div>
                    <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-black focus:outline-0 focus:ring-0 border-none bg-white focus:border-none h-full placeholder:text-[var(--text-grey)] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal" placeholder="Buscar candidato por nome" value=""/>
                </div>
            </label>
        </div>
        <div class="flex gap-3 p-3 flex-wrap pr-4">
            <div class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-xl bg-[var(--primary-yellow)] pl-4 pr-4">
                <p class="text-black text-sm font-medium leading-normal">Todos</p>
            </div>
            <div class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-xl border border-[var(--dark-grey)] pl-4 pr-4"><p class="text-black text-sm font-medium leading-normal">Aguardando análise</p></div>
            <div class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-xl border border-[var(--dark-grey)] pl-4 pr-4"><p class="text-black text-sm font-medium leading-normal">Aprovados</p></div>
            <div class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-xl border border-[var(--dark-grey)] pl-4 pr-4"><p class="text-black text-sm font-medium leading-normal">Recusados</p></div>
        </div>

        <div id="candidates-list-container" class="p-4 space-y-4">
            <p id="loading-candidates-message" class="text-center text-[var(--text-grey)]">Carregando candidatos...</p>
            </div>

        <p class="text-[var(--text-grey)] text-sm font-normal leading-normal pb-3 pt-1 px-4 text-center">
              Certificados e habilidades disponíveis no currículo digital (funcionalidade futura).
        </p>
    </div>

    <div>
        <div class="flex px-4 py-3 justify-center">
            <button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 px-4 bg-black text-white gap-2 pl-4 text-sm font-bold leading-normal tracking-[0.015em]">
                <div class="text-[var(--primary-yellow)]">
                    <svg fill="currentColor" height="20px" viewBox="0 0 256 256" width="20px" xmlns="http://www.w3.org/2000/svg"><path d="M224,152v56a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V152a8,8,0,0,1,16,0v56H208V152a8,8,0,0,1,16,0Zm-101.66,5.66a8,8,0,0,0,11.32,0l40-40a8,8,0,0,0-11.32-11.32L136,132.69V40a8,8,0,0,0-16,0v92.69L93.66,106.34a8,8,0,0,0-11.32,11.32Z"></path></svg>
                </div>
                <span class="truncate">Exportar Lista de Candidatos em PDF</span>
            </button>
        </div>
        <footer class="flex flex-col gap-6 px-5 py-10 text-center @container bg-black">
            <div class="w-full h-px bg-[var(--primary-yellow)]"></div>
            <p class="text-white text-base font-normal leading-normal">© 2025 AssisFreela — Conectando oportunidades e talentos locais.</p>
        </footer>
    </div>
</div>

<script>
    const candidatesContainer = document.getElementById('candidates-list-container');
    const loadingMessage = document.getElementById('loading-candidates-message');
    const vagaTitleElement = document.getElementById('vaga-title');
    const token = localStorage.getItem("accessToken");

    function getVagaIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('vagaId');
    }

    // --- FUNÇÃO ATUALIZADA (fetchAndRenderCandidates) ---
    async function fetchAndRenderCandidates() {
        const vagaId = getVagaIdFromUrl();

        if (!vagaId) { /* ... (tratamento de erro ID não encontrado) ... */ return; }
        if (!token) { /* ... (tratamento de erro token não encontrado) ... */ return; }

        // --- NOVA CHAMADA PARA BUSCAR DETALHES DA VAGA ---
        try {
            const vagaResponse = await fetch(`/vagas/${vagaId}`, {
                 headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!vagaResponse.ok) {
                 // Tratar erro ao buscar vaga (404, 403 etc.)
                 throw new Error("Não foi possível carregar detalhes da vaga.");
            }
            const vagaDetails = await vagaResponse.json();
            vagaTitleElement.textContent = vagaDetails.titulo || `Candidatos para Vaga ID: ${vagaId}`; // Usa o título real!
        } catch(error) {
             console.error("Erro ao buscar detalhes da vaga:", error);
             vagaTitleElement.textContent = "Erro ao carregar detalhes da vaga";
        }
        // --- FIM DA NOVA CHAMADA ---

        // Continua buscando os candidatos...
        try {
            const response = await fetch(`/vagas/${vagaId}/candidates`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) { /* ... (tratamento de erro candidatos) ... */ throw new Error(`HTTP error! status: ${response.status}`); }

            const candidates = await response.json();
            candidatesContainer.innerHTML = ''; // Limpa container

            if (candidates.length === 0) { /* ... (mensagem nenhum candidato) ... */ return; }

            candidates.forEach(candidate => {
                const candidateCardHtml = `
                    <div class="candidate-card bg-white rounded-xl shadow-md p-4 flex flex-col gap-4 border border-[var(--light-grey)]" data-email="${candidate.email}">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-center bg-no-repeat bg-cover rounded-full shrink-0 bg-gray-300 flex items-center justify-center">
                               <span class="material-symbols-outlined text-gray-500 text-4xl">person</span>
                            </div>
                            <div class="flex flex-col gap-1 flex-grow">
                                <p class="text-black text-lg font-bold leading-tight">${candidate.full_name || 'Nome não informado'}</p>
                                <p class="text-[var(--text-grey)] text-sm font-normal leading-normal">Email: ${candidate.email}</p>
                                <p class="text-[var(--text-grey)] text-sm font-normal leading-normal">Telefone: ${candidate.phone || 'Não informado'}</p>
                            </div>
                            <a class="view-profile-link shrink-0 flex items-center justify-center size-8 rounded-full bg-[var(--light-grey)] hover:bg-gray-300 transition" href="Perfil_Publico_Freelancer.html?email=${candidate.email}" title="Ver Perfil Completo">
                                <span class="material-symbols-outlined text-black text-lg">arrow_forward</span>
                            </a>
                        </div>
                        <div class="candidate-actions flex gap-2">
                            <button class="accept-btn flex flex-1 items-center justify-center overflow-hidden rounded-xl h-12 px-4 bg-[var(--primary-yellow)] text-black text-base font-bold leading-normal tracking-[0.015em] hover:opacity-90" data-freelancer-email="${candidate.email}">
                                <span class="truncate">Aceitar</span>
                            </button>
                            <button class="reject-btn flex flex-1 items-center justify-center overflow-hidden rounded-xl h-12 px-4 border border-black bg-white text-black text-base font-bold leading-normal tracking-[0.015em] hover:bg-gray-50" data-freelancer-email="${candidate.email}">
                                <span class="truncate">Recusar</span>
                            </button>
                        </div>
                        <div class="candidate-status text-center font-semibold mt-2 hidden"></div> </div>
                `;
                candidatesContainer.innerHTML += candidateCardHtml;
            });

        } catch (error) { /* ... (tratamento de erro candidatos) ... */ }
    }
// --- FUNÇÃO ATUALIZADA (handleCandidateAction - Mais Robusta) ---
    async function handleCandidateAction(event) {
        const acceptButton = event.target.closest('.accept-btn');
        const rejectButton = event.target.closest('.reject-btn');
        const viewProfileButton = event.target.closest('.view-profile-btn');

        if (!acceptButton && !rejectButton && !viewProfileButton) { return; }

        const button = acceptButton || rejectButton;
        // Sai se o botão já estiver desabilitado (prevenção extra)
        if (button.disabled) return;

        const action = acceptButton ? 'accept' : 'reject';
        const freelancerEmail = button.dataset.freelancerEmail;
        const vagaId = getVagaIdFromUrl();
        const card = button.closest('.candidate-card');
        const statusDiv = card.querySelector('.candidate-status');
        const actionsDiv = card.querySelector('.candidate-actions');
        const allActionButtons = actionsDiv.querySelectorAll('button'); // Pega ambos os botões

        if (!vagaId || !freelancerEmail || !token || !card || !statusDiv || !actionsDiv) {
            alert("Erro interno: Elementos do card não encontrados.");
            console.error("Elementos faltando:", { vagaId, freelancerEmail, token, card, statusDiv, actionsDiv });
            return;
         }

        // Feedback visual e desabilita AMBOS os botões
        button.textContent = action === 'accept' ? 'Aceitando...' : 'Recusando...';
        allActionButtons.forEach(btn => btn.disabled = true); // Desabilita explicitamente

        try {
            const response = await fetch(`/vagas/${vagaId}/candidates/${freelancerEmail}/${action}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const result = await response.json();

            if (response.ok) {
                // Sucesso! Atualiza a UI permanentemente
                actionsDiv.classList.add('hidden');      // Esconde a div dos botões
                statusDiv.classList.remove('hidden');    // Mostra a div de status

                if (action === 'accept') {
                    statusDiv.textContent = 'ACEITO';
                    statusDiv.classList.add('text-green-600');
                    alert(result.message || 'Candidato aceito!');

                    // Atualiza outros cards
                    document.querySelectorAll('.candidate-card').forEach(otherCard => {
                        if (otherCard === card) return; // Pula o card atual
                        const otherActionsDiv = otherCard.querySelector('.candidate-actions');
                        const otherStatusDiv = otherCard.querySelector('.candidate-status');
                        if (otherActionsDiv && !otherActionsDiv.classList.contains('hidden')) {
                            otherActionsDiv.classList.add('hidden'); // Esconde botões
                             otherActionsDiv.querySelectorAll('button').forEach(btn => btn.disabled = true); // Garante desabilitação
                            if(otherStatusDiv){
                                otherStatusDiv.textContent = 'NÃO SELECIONADO';
                                otherStatusDiv.classList.add('text-gray-500', 'text-sm');
                                otherStatusDiv.classList.remove('hidden');
                            }
                        }
                    });

                } else { // Recusado
                    statusDiv.textContent = 'RECUSADO';
                    statusDiv.classList.add('text-red-600');
                    alert(result.message || 'Candidato recusado.');
                }

            } else {
                 // Erro da API (4xx) - Reabilita botões
                 alert(`Erro: ${result.detail || 'Não foi possível completar a ação.'}`);
                 button.textContent = action === 'accept' ? 'Aceitar' : 'Recusar'; // Restaura texto do botão clicado
                 allActionButtons.forEach(btn => btn.disabled = false); // Reabilita ambos
            }

        } catch (error) {
             // Erro de Rede - Reabilita botões
            console.error(`Erro na requisição ${action}:`, error);
            alert("Erro de conexão. Tente novamente.");
            button.textContent = action === 'accept' ? 'Aceitar' : 'Recusar'; // Restaura texto
            allActionButtons.forEach(btn => btn.disabled = false); // Reabilita ambos
        }
    }

    document.addEventListener('DOMContentLoaded', fetchAndRenderCandidates);
    candidatesContainer.addEventListener('click', handleCandidateAction);
</script>
</body>
</html>