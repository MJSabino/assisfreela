<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>AssisFreela - Editar Perfil da Empresa</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#FFB300",
                        "background-light": "#F5F5F5",
                        "background-dark": "#121212",
                        "card-dark": "#1F1F1F",
                        "text-light": "#000000",
                        "text-dark": "#FFFFFF",
                    },
                    fontFamily: {
                        display: ["Montserrat", "sans-serif"],
                        body: ["Poppins", "sans-serif"],
                    },
                    borderRadius: {
                        'DEFAULT': '0.5rem',
                    },
                },
            },
        };
    </script>
     <style type="text/tailwindcss">
        .font-display { font-family: 'Montserrat', sans-serif; font-weight: 800; } .font-body { font-family: 'Poppins', sans-serif; }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark font-body">
    <div class="flex min-h-screen">
        <aside class="w-64 bg-card-dark text-text-dark hidden lg:block p-4">
            <h1 class="text-2xl font-display text-primary mb-8">AssisFreela</h1>
            <nav>
                <a href="Perfil_Empresa.html" class="flex items-center p-3 rounded-lg text-sm hover:bg-primary/20 transition-colors mb-2">
                    <span class="material-symbols-outlined mr-3">dashboard</span> Painel
                </a>
                 <a href="Criacao_novas_vagas.html" class="flex items-center p-3 rounded-lg text-sm hover:bg-primary/20 transition-colors mb-2">
                    <span class="material-symbols-outlined mr-3">add_box</span> Publicar Vaga
                </a>
                <a href="Perfil_Empresa.html" class="flex items-center p-3 rounded-lg text-sm hover:bg-primary/20 transition-colors mb-2">
                    <span class="material-symbols-outlined mr-3">work</span> Minhas Vagas
                </a>
                <a href="#" class="flex items-center p-3 rounded-lg bg-primary/30 text-primary font-semibold text-sm mb-2"> <span class="material-symbols-outlined mr-3">edit_note</span> Editar Perfil
                </a>
                <a href="#" id="logout-button-sidebar" class="flex items-center p-3 rounded-lg text-sm hover:bg-primary/20 transition-colors mt-auto"> <span class="material-symbols-outlined mr-3">logout</span> Sair
                </a>
            </nav>
        </aside>

        <main class="flex-1 p-8">
            <header class="mb-8">
                <h2 class="text-3xl font-display text-text-light dark:text-text-dark mb-2">Editar Perfil da Empresa</h2>
                <p class="text-text-light/70 dark:text-text-dark/70">Atualize as informações da sua empresa.</p>
            </header>

            <form id="edit-profile-form" class="bg-white dark:bg-card-dark p-6 rounded-xl shadow-lg max-w-2xl">

                <div class="mb-4">
                    <label for="company_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome da Empresa</label>
                    <input type="text" id="company_name" name="company_name" required
                           class="w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg focus:ring-primary focus:border-primary">
                </div>

                <div class="mb-4">
                    <label for="cnpj" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CNPJ</label>
                    <input type="text" id="cnpj" name="cnpj"
                           class="w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg focus:ring-primary focus:border-primary">
                </div>

                <div class="mb-4">
                    <label for="address" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Endereço</label>
                    <input type="text" id="address" name="address"
                           class="w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg focus:ring-primary focus:border-primary">
                </div>

                <div class="mb-4">
                    <label for="phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Telefone</label>
                    <input type="tel" id="phone" name="phone"
                           class="w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg focus:ring-primary focus:border-primary">
                </div>

                <div class="mb-4">
                    <label for="industry" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Setor de Atuação</label>
                    <input type="text" id="industry" name="industry"
                           class="w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg focus:ring-primary focus:border-primary">
                    </select>
                </div>

                 <div id="message-container" class="mb-4 text-center h-5"></div>


                <div class="flex justify-end pt-4">
                    <a href="Perfil_Empresa.html" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors mr-4">
                        Cancelar
                    </a>
                    <button type="submit" class="px-6 py-2 bg-primary text-black font-bold rounded-lg hover:bg-yellow-400 transition-colors shadow-md">
                        <span class="material-symbols-outlined align-middle mr-1">save</span>
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </main>
    </div>

    <script>
        const form = document.getElementById('edit-profile-form');
        const messageContainer = document.getElementById('message-container');
        const token = localStorage.getItem("accessToken");

        // Função para mostrar mensagens
        function showMessage(message, isError = false) {
            messageContainer.innerHTML = ''; // Limpa mensagens antigas
            const p = document.createElement('p');
            p.textContent = message;
            p.className = isError
                ? 'text-red-600 font-semibold'
                : 'text-green-600 font-semibold';
            messageContainer.appendChild(p);
        }

        // --- 1. Carregar Dados Atuais no Formulário ---
        document.addEventListener("DOMContentLoaded", async () => {
            if (!token) {
                window.location.href = "../login.html";
                return;
            }

            try {
                const response = await fetch("http://127.0.0.1:8000/users/me", {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (!response.ok) {
                     if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem("accessToken");
                        window.location.href = "../login.html";
                     }
                    throw new Error("Falha ao carregar dados do perfil.");
                }

                const user = await response.json();

                // Preenche os campos do formulário
                document.getElementById('company_name').value = user.company_name || '';
                document.getElementById('cnpj').value = user.cnpj || '';
                document.getElementById('address').value = user.address || '';
                document.getElementById('phone').value = user.phone || '';
                document.getElementById('industry').value = user.industry || '';

            } catch (error) {
                console.error("Erro ao carregar perfil:", error);
                showMessage("Erro ao carregar dados. Tente atualizar a página.", true);
            }
        });

        // --- 2. Enviar Atualizações ---
        form.addEventListener("submit", async (event) => {
            event.preventDefault(); // Impede o envio padrão
            showMessage("Salvando...", false); // Feedback visual

            if (!token) {
                 showMessage("Sessão expirada. Redirecionando...", true);
                 setTimeout(() => { window.location.href = "../login.html"; }, 2000);
                 return;
            }

            // Coleta os dados do formulário
            const updateData = {
                company_name: document.getElementById('company_name').value,
                cnpj: document.getElementById('cnpj').value,
                address: document.getElementById('address').value,
                phone: document.getElementById('phone').value,
                industry: document.getElementById('industry').value
            };

            // Remove campos vazios para não enviar null se não for intenção
            // (O backend já lida com isso com exclude_unset=True, mas é uma boa prática)
            Object.keys(updateData).forEach(key => {
                if (updateData[key] === null || updateData[key] === '') {
                    delete updateData[key];
                }
            });

            try {
                const response = await fetch("http://127.0.0.1:8000/users/me", {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage("Perfil atualizado com sucesso!", false);
                    // Opcional: Redirecionar de volta após um tempo
                    setTimeout(() => {
                        window.location.href = "Perfil_Empresa.html";
                    }, 1500);
                } else {
                    showMessage(`Erro ao atualizar: ${result.detail || 'Erro desconhecido.'}`, true);
                }

            } catch (error) {
                console.error("Erro na requisição PUT:", error);
                showMessage("Erro de conexão ao salvar. Tente novamente.", true);
            }
        });

         // Script de Logout para a Sidebar (se existir)
         const logoutButtonSidebar = document.getElementById("logout-button-sidebar");
         if (logoutButtonSidebar) {
             logoutButtonSidebar.addEventListener("click", function(e) {
                 e.preventDefault();
                 localStorage.removeItem("accessToken");
                 localStorage.removeItem("username");
                 localStorage.removeItem("userRole");
                 window.location.href = "../login.html";
             });
         }

    </script>
    </body>
</html>