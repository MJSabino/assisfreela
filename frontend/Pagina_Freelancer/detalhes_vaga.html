<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Detalhes da Vaga - AssisFreela</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: '#6366F1', 
                        'background-light': '#F8F9FA',
                        'background-dark': '#121212',
                        'surface-light': '#FFFFFF',
                        'surface-dark': '#1E1E1E',
                        'text-light': '#1F2937',
                        'text-dark': '#E5E7EB',
                        'text-secondary-light': '#6B7280',
                        'text-secondary-dark': '#9CA3AF',
                        'border-light': '#E5E7EB',
                        'border-dark': '#374151',
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"], 
                    },
                    borderRadius: {
                        'DEFAULT': '0.75rem',
                        'lg': '1rem',
                        'xl': '1.25rem'
                    },
                },
            },
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            min-height: max(884px, 100dvh);
        }
        /* Para formatar a descrição em HTML */
        .prose-custom {
            color: #1F2937; /* text-light */
        }
        .dark .prose-custom {
            color: #E5E7EB; /* text-dark */
        }
        .prose-custom p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose-custom ul { margin-top: 0.5em; margin-bottom: 0.5em; padding-left: 1.5em; }
        .prose-custom li { margin-top: 0.25em; margin-bottom: 0.25em; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark">
<div class="container mx-auto p-4 max-w-3xl">
    <header class="flex items-center justify-between mb-6">
        <a href="Vagas_disponiveis.html" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
            <span class="material-icons text-text-light dark:text-text-dark">arrow_back</span>
        </a>
        <h1 class="text-xl font-bold">Detalhes da Vaga</h1>
        <div class="w-10"></div> </header>

    <main id="vaga-detalhes-container" class="bg-surface-light dark:bg-surface-dark p-6 md:p-8 rounded-xl border border-border-light dark:border-border-dark shadow-lg">
        <p id="loading-message" class="text-center text-text-secondary-light dark:text-text-secondary-dark">Carregando detalhes da vaga...</p>
        
        </main>

    <div id="message-container" class="mt-4 text-center h-5"></div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const vagaContainer = document.getElementById('vaga-detalhes-container');
        const loadingMessage = document.getElementById('loading-message');
        const messageContainer = document.getElementById('message-container');
        
        let vagaId = null;

        // --- 1. Buscar ID da Vaga na URL ---
        try {
            const urlParams = new URLSearchParams(window.location.search);
            vagaId = urlParams.get('id');
            if (!vagaId) {
                throw new Error("ID da vaga não encontrado na URL.");
            }
        } catch (error) {
            console.error(error);
            loadingMessage.textContent = "Erro: ID da vaga não especificado. Volte e tente novamente.";
            loadingMessage.style.color = "red";
            return;
        }

        // --- 2. Buscar Detalhes da Vaga Específica ---
        async function fetchDetalhesVaga(id) {
            try {
                const response = await fetch(`http:///vagas/${id}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const vaga = await response.json();
                renderVagaDetalhes(vaga);
            } catch (error) {
                console.error("Erro ao buscar detalhes da vaga:", error);
                loadingMessage.textContent = "Erro ao carregar os detalhes desta vaga.";
                loadingMessage.style.color = "red";
            }
        }

        // --- 3. Renderizar Detalhes da Vaga ---
        function renderVagaDetalhes(vaga) {
            loadingMessage.style.display = 'none'; // Esconde o "Carregando"
            
            const orcamentoFormatado = vaga.orcamento.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const dataPublicacao = new Date(vaga.created_at).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            // Converte quebras de linha em <br> para a descrição
            const descricaoHtml = vaga.descricao.replace(/\n/g, '<br>');

            const habilidadesHtml = vaga.habilidades 
                ? vaga.habilidades.split(',')
                    .map(h => `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">${h.trim()}</span>`)
                    .join(' ')
                : '<span class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Não especificado</span>';

            vagaContainer.innerHTML = `
                <div class="pb-4 border-b border-border-light dark:border-border-dark">
                    <h2 class="text-3xl font-bold text-text-light dark:text-text-dark">${vaga.titulo}</h2>
                    <p class="mt-1 text-lg text-text-secondary-light dark:text-text-secondary-dark">por ${vaga.owner_email}</p>
                    <p class="mt-1 text-sm text-text-secondary-light dark:text-text-secondary-dark">Publicado em: ${dataPublicacao}</p>
                </div>

                <div class="mt-6 mb-6">
                    <button id="apply-button" class="apply-button w-full bg-primary text-white font-medium py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors" data-vaga-id="${vaga.id}">
                        Candidatar-se
                    </button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-background-light dark:bg-background-dark p-4 rounded-lg text-center">
                        <span class="text-sm uppercase text-text-secondary-light dark:text-text-secondary-dark">Orçamento</span>
                        <p class="text-xl font-bold text-primary dark:text-indigo-400">${orcamentoFormatado}${vaga.tipo_pagamento === 'hora' ? '/hora' : ''}</p>
                    </div>
                    <div class="bg-background-light dark:bg-background-dark p-4 rounded-lg text-center">
                        <span class="text-sm uppercase text-text-secondary-light dark:text-text-secondary-dark">Nível</span>
                        <p class="text-xl font-bold text-text-light dark:text-text-dark">${vaga.nivel}</p>
                    </div>
                    <div class="bg-background-light dark:bg-background-dark p-4 rounded-lg text-center">
                        <span class="text-sm uppercase text-text-secondary-light dark:text-text-secondary-dark">Prazo</span>
                        <p class="text-xl font-bold text-text-light dark:text-text-dark">${vaga.prazo ? `${vaga.prazo} dias` : 'N/A'}</p>
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="text-xl font-semibold mb-2">Descrição Completa</h4>
                    <div class="prose-custom">${descricaoHtml}</div>
                </div>

                <div>
                    <h4 class="text-xl font-semibold mb-3">Habilidades Necessárias</h4>
                    <div class="flex flex-wrap gap-2">
                        ${habilidadesHtml}
                    </div>
                </div>
            `;
            
            // Adiciona o listener de clique AO BOTÃO que acabamos de criar
            const applyButton = document.getElementById('apply-button');
            if(applyButton) {
                applyButton.addEventListener('click', handleApplyClick);
            }
        }

        // --- 4. Função para Candidatar-se (Reutilizada da página anterior) ---
        async function handleApplyClick(event) {
            const applyButton = event.currentTarget; // O botão que foi clicado
            
            applyButton.disabled = true;
            applyButton.textContent = 'Enviando...';

            const vagaId = applyButton.dataset.vagaId;
            const token = localStorage.getItem("accessToken");
            const userRole = localStorage.getItem("userRole");

            if (!token) {
                showFeedbackMessage("Você precisa estar logado para se candidatar.", true);
                setTimeout(() => { window.location.href = "/login.html"; }, 2000); 
                applyButton.disabled = false;
                applyButton.textContent = 'Candidatar-se';
                return;
            }

            if (userRole !== 'FREELANCER') {
                showFeedbackMessage("Apenas freelancers podem se candidatar a vagas.", true);
                applyButton.disabled = false;
                applyButton.textContent = 'Candidatar-se';
                return;
            }

            try {
                const response = await fetch(`http:///vagas/${vagaId}/apply`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json(); 
                if (response.ok) {
                    showFeedbackMessage(result.message || "Candidatura enviada com sucesso!", false);
                    applyButton.textContent = 'Candidatado!';
                    applyButton.classList.remove('bg-primary', 'hover:bg-indigo-700');
                    applyButton.classList.add('bg-green-500', 'text-white');
                } else {
                    showFeedbackMessage(result.detail || "Erro ao enviar candidatura.", true);
                    applyButton.disabled = false; 
                    applyButton.textContent = 'Candidatar-se';
                }
            } catch (error) {
                console.error("Erro na requisição de candidatura:", error);
                showFeedbackMessage("Erro de conexão. Tente novamente.", true);
                applyButton.disabled = false; 
                applyButton.textContent = 'Candidatar-se';
            }
        }
        
        // --- 5. Função Auxiliar de Feedback ---
        function showFeedbackMessage(message, isError = false) {
            messageContainer.innerHTML = '';
            const p = document.createElement('p');
            p.textContent = message;
            p.className = isError ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold';
            messageContainer.appendChild(p);
            setTimeout(() => { messageContainer.innerHTML = ''; }, 3000);
        }

        // --- 6. Inicia a Busca ---
        fetchDetalhesVaga(vagaId);
    });
</script>
</body>
</html>